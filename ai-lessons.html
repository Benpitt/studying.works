<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Lessons - studying.works</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="apple-style.css">
    <link rel="stylesheet" href="global-styles.css">
    <link rel="stylesheet" href="button-styles.css">
    <link rel="stylesheet" href="loading-animations.css">
</head>
<body>
    <a href="#main-content" class="skip-to-main">Skip to main content</a>
    <script type="module" src="auth-guard.js"></script>

    <!-- Navbar -->
    <nav class="bg-black/30 backdrop-blur-lg border-b border-white/10 fixed top-0 left-0 right-0 z-50 animate-slide-in">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-8">
                    <a href="dashboard" class="text-2xl font-bold text-white flex items-center space-x-2 hover:scale-105 transition-transform">
                        <span>üéì</span>
                        <span>studying.works</span>
                    </a>
                    <div class="hidden md:flex space-x-4">
                        <a href="dashboard" class="text-white/80 hover:text-white hover:bg-white/10 px-3 py-2 rounded-lg transition-all">Dashboard</a>
                        <a href="progress" class="text-white/80 hover:text-white hover:bg-white/10 px-3 py-2 rounded-lg transition-all">Progress</a>
                        <a href="about" class="text-white/80 hover:text-white hover:bg-white/10 px-3 py-2 rounded-lg transition-all">About</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex items-center space-x-2 bg-red-500/20 px-4 py-2 rounded-full border border-red-500/50">
                        <span class="text-2xl animate-pulse-custom">üî•</span>
                        <span class="text-white font-bold"><span id="streak">0</span> Day Streak</span>
                    </div>
                    <div class="relative group">
                        <button class="flex items-center space-x-3 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full transition-all">
                            <img id="user-photo" src="https://via.placeholder.com/40" alt="User profile photo" class="w-8 h-8 rounded-full" loading="lazy">
                            <span id="user-name-nav" class="text-white font-semibold hidden md:block">User</span>
                        </button>
                        <div class="absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all">
                            <div class="p-4">
                                <p id="user-email" class="text-sm text-gray-600 mb-3 break-words overflow-wrap"></p>
                                <div class="space-y-2 mb-3">
                                    <a href="tutorial" class="flex items-center space-x-2 w-full text-left px-4 py-2 text-gray-700 hover:bg-purple-50 rounded-lg transition-all">
                                        <span>üìö</span>
                                        <span>Tutorial</span>
                                    </a>
                                    <a href="settings" class="flex items-center space-x-2 w-full text-left px-4 py-2 text-gray-700 hover:bg-blue-50 rounded-lg transition-all">
                                        <span>‚öôÔ∏è</span>
                                        <span>Settings</span>
                                    </a>
                                </div>
                                <button id="signout-btn" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="bg-black/20 backdrop-blur-sm border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 pt-20">
            <nav class="flex items-center space-x-2 text-sm">
                <a href="dashboard" class="text-white/60 hover:text-white transition-colors">Dashboard</a>
                <svg class="w-4 h-4 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                <span class="text-white font-medium">AI Lessons</span>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="p-4 pb-20">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8 animate-slide-in">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-4xl font-black text-white mb-2">üéì AI Lessons</h1>
                        <p class="text-white/60">Create interactive AI-powered lessons from your notes</p>
                    </div>
                    <button onclick="showCreateLesson()" class="btn-primary flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Create Lesson
                    </button>
                </div>
            </div>

            <!-- Library View -->
            <div id="libraryView" class="animate-slide-in delay-100">
                <div id="lessonsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Lessons will be dynamically inserted here -->
                </div>
                <div id="emptyState" class="text-center py-20 hidden">
                    <div class="text-6xl mb-4">üìö</div>
                    <h3 class="text-2xl font-bold text-white mb-2">No lessons yet</h3>
                    <p class="text-white/60 mb-6">Create your first AI-powered lesson to get started</p>
                    <button onclick="showCreateLesson()" class="btn-primary">Create Your First Lesson</button>
                </div>
            </div>

            <!-- Create Lesson View -->
            <div id="createView" class="hidden">
                <div class="max-w-4xl mx-auto">
                    <!-- Step 1: Input Notes -->
                    <div id="step1" class="card-gradient-indigo rounded-2xl p-8 mb-6 animate-slide-in">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-white">Step 1: Input Your Notes</h2>
                            <button onclick="showLibrary()" class="text-white/60 hover:text-white transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="mb-4">
                            <label class="block text-white/80 mb-2 font-medium">Subject/Topic</label>
                            <input
                                type="text"
                                id="lessonSubject"
                                placeholder="e.g., Photosynthesis, World War II, Calculus"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all"
                            >
                        </div>
                        <div class="mb-6">
                            <label class="block text-white/80 mb-2 font-medium">Your Notes</label>
                            <textarea
                                id="lessonNotes"
                                rows="8"
                                placeholder="Paste your notes here... The AI will use these to generate comprehensive lessons and practice questions."
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all resize-none"
                            ></textarea>
                        </div>
                        <button onclick="generatePrompt()" class="btn-primary w-full">
                            Generate AI Prompt
                        </button>
                    </div>

                    <!-- Step 2: AI Prompt -->
                    <div id="step2" class="card-gradient-purple rounded-2xl p-8 mb-6 hidden animate-slide-in">
                        <h2 class="text-2xl font-bold text-white mb-4">Step 2: Copy AI Prompt</h2>
                        <p class="text-white/80 mb-4">Copy this prompt and paste it into your favorite AI model (ChatGPT, Claude, etc.)</p>
                        <div class="bg-black/30 rounded-xl p-4 mb-4 relative">
                            <pre id="aiPrompt" class="text-white/90 text-sm whitespace-pre-wrap overflow-x-auto max-h-96"></pre>
                            <button onclick="copyPrompt()" class="absolute top-4 right-4 btn-secondary text-sm">
                                üìã Copy
                            </button>
                        </div>
                        <button onclick="showStep3()" class="btn-primary w-full">
                            Continue to Import JSON
                        </button>
                    </div>

                    <!-- Step 3: Import JSON -->
                    <div id="step3" class="card-gradient-success rounded-2xl p-8 hidden animate-slide-in">
                        <h2 class="text-2xl font-bold text-white mb-4">Step 3: Import AI Response</h2>
                        <p class="text-white/80 mb-4">Paste the JSON response from the AI model here</p>
                        <div class="mb-6">
                            <textarea
                                id="jsonInput"
                                rows="12"
                                placeholder='{"subject": "...", "lessons": [...], "practiceQuestions": [...]}'
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-transparent transition-all resize-none font-mono text-sm"
                            ></textarea>
                        </div>
                        <div id="jsonError" class="hidden bg-red-500/20 border border-red-500/40 rounded-xl p-4 mb-4">
                            <p class="text-red-200 text-sm"></p>
                        </div>
                        <button onclick="importLesson()" class="btn-primary w-full">
                            Import Lesson
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lesson View -->
            <div id="lessonView" class="hidden">
                <div class="max-w-4xl mx-auto">
                    <!-- Lesson Header -->
                    <div class="mb-6 flex items-center justify-between">
                        <button onclick="showLibrary()" class="text-white/60 hover:text-white transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                            Back to Library
                        </button>
                        <button onclick="deleteCurrentLesson()" class="text-red-400 hover:text-red-300 transition-colors">
                            Delete Lesson
                        </button>
                    </div>

                    <div id="lessonContent" class="space-y-6">
                        <!-- Lesson content will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="dynamic-gradient.js"></script>
    <script type="module" src="lessons-storage.js"></script>
    <script type="module" src="auth-service.js"></script>
    <script>
        let currentLesson = null;
        let currentLessonId = null;
        let currentPage = 0; // 0-based index for lessons, last page is practice questions

        // Initialize
        async function init() {
            await loadLessons();
            await loadUserData();
        }

        // Load user data for navbar
        async function loadUserData() {
            try {
                const authService = window.authService;
                if (authService && authService.currentUser) {
                    const user = authService.currentUser;

                    // Update user info in navbar
                    const userPhoto = document.getElementById('user-photo');
                    const userName = document.getElementById('user-name-nav');
                    const userEmail = document.getElementById('user-email');

                    if (userPhoto && user.photoURL) userPhoto.src = user.photoURL;
                    if (userName) userName.textContent = user.displayName || 'User';
                    if (userEmail) userEmail.textContent = user.email;
                }

                // Load streak
                const streak = localStorage.getItem('currentStreak') || 0;
                const streakElem = document.getElementById('streak');
                if (streakElem) streakElem.textContent = streak;

                // Setup signout button
                const signoutBtn = document.getElementById('signout-btn');
                if (signoutBtn) {
                    signoutBtn.addEventListener('click', async () => {
                        await window.authService.signOut();
                        window.location.href = '/';
                    });
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load all lessons
        async function loadLessons() {
            const lessons = await window.lessonsStorage.getAllLessons();
            const grid = document.getElementById('lessonsGrid');
            const emptyState = document.getElementById('emptyState');

            if (lessons.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');

            // Sort by created date (newest first)
            lessons.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            grid.innerHTML = lessons.map((lesson, index) => {
                const gradients = ['indigo', 'purple', 'blue', 'emerald', 'rose', 'violet'];
                const gradient = gradients[index % gradients.length];
                const lessonCount = lesson.lessons?.length || 0;
                const questionCount = lesson.practiceQuestions?.length || 0;

                return `
                    <div class="card-gradient-${gradient} rounded-2xl p-6 card-hover relative overflow-hidden group cursor-pointer animate-slide-in delay-${Math.min(index * 100, 500)}" onclick="viewLesson('${lesson.id}')">
                        <div class="absolute inset-0 shimmer opacity-0 group-hover:opacity-100"></div>
                        <div class="relative z-10">
                            <h3 class="text-xl font-bold text-white mb-2">${escapeHtml(lesson.subject)}</h3>
                            <p class="text-white/70 text-sm mb-4">${lessonCount} lesson${lessonCount !== 1 ? 's' : ''} ‚Ä¢ ${questionCount} practice question${questionCount !== 1 ? 's' : ''}</p>
                            <div class="text-white/50 text-xs">
                                Created ${formatDate(lesson.createdAt)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show library view
        function showLibrary() {
            document.getElementById('libraryView').classList.remove('hidden');
            document.getElementById('createView').classList.add('hidden');
            document.getElementById('lessonView').classList.add('hidden');
            loadLessons();
        }

        // Show create lesson view
        function showCreateLesson() {
            document.getElementById('libraryView').classList.add('hidden');
            document.getElementById('createView').classList.remove('hidden');
            document.getElementById('lessonView').classList.add('hidden');

            // Reset form
            document.getElementById('lessonSubject').value = '';
            document.getElementById('lessonNotes').value = '';
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
        }

        // Generate AI prompt
        function generatePrompt() {
            const subject = document.getElementById('lessonSubject').value.trim();
            const notes = document.getElementById('lessonNotes').value.trim();

            if (!subject || !notes) {
                alert('Please fill in both subject and notes');
                return;
            }

            const prompt = `Create a comprehensive educational lesson based on the following notes. Return ONLY valid JSON with no additional text or formatting.

Subject: ${subject}

Notes:
${notes}

Generate a JSON object with this exact structure:
{
  "subject": "${subject}",
  "lessons": [
    {
      "title": "Lesson title",
      "content": [
        {
          "type": "heading",
          "text": "Section heading"
        },
        {
          "type": "paragraph",
          "text": "Detailed explanation..."
        },
        {
          "type": "bullet",
          "items": ["Key point 1", "Key point 2", "Key point 3"]
        },
        {
          "type": "highlight",
          "text": "Important concept to remember"
        }
      ]
    }
  ],
  "practiceQuestions": [
    {
      "question": "Question text",
      "options": ["Option A", "Option B", "Option C", "Option D"],
      "correctAnswer": 0,
      "explanation": "Why this answer is correct"
    }
  ]
}

Guidelines:
- Create 2-4 comprehensive lessons that build on each other
- Each lesson should have clear sections with headings
- Use bullet points for lists and key concepts
- Highlight important information
- Create 5-10 practice questions that test understanding
- Questions should range from basic recall to application
- Include detailed explanations for answers

Return ONLY the JSON object, no markdown formatting or code blocks.`;

            document.getElementById('aiPrompt').textContent = prompt;
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
        }

        // Copy prompt to clipboard
        async function copyPrompt() {
            const prompt = document.getElementById('aiPrompt').textContent;
            await navigator.clipboard.writeText(prompt);

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Copied!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }

        // Show step 3
        function showStep3() {
            document.getElementById('step3').classList.remove('hidden');
            document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
        }

        // Import lesson from JSON
        async function importLesson() {
            const jsonInput = document.getElementById('jsonInput').value.trim();
            const errorDiv = document.getElementById('jsonError');
            const errorText = errorDiv.querySelector('p');

            errorDiv.classList.add('hidden');

            if (!jsonInput) {
                errorText.textContent = 'Please paste the JSON response';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                // Parse JSON
                const lessonData = JSON.parse(jsonInput);

                // Validate structure
                if (!lessonData.subject || !lessonData.lessons || !lessonData.practiceQuestions) {
                    throw new Error('Invalid JSON structure. Missing required fields: subject, lessons, or practiceQuestions');
                }

                // Create lesson object
                const lesson = {
                    id: Date.now().toString(),
                    createdAt: new Date().toISOString(),
                    ...lessonData
                };

                // Save to storage
                await window.lessonsStorage.saveLesson(lesson);

                // View the lesson
                viewLesson(lesson.id);
            } catch (error) {
                errorText.textContent = `Error: ${error.message}`;
                errorDiv.classList.remove('hidden');
            }
        }

        // View a lesson
        async function viewLesson(lessonId, page = 0) {
            currentLessonId = lessonId;
            currentPage = page;
            const lesson = await window.lessonsStorage.getLesson(lessonId);

            if (!lesson) {
                alert('Lesson not found');
                return;
            }

            currentLesson = lesson;

            // Hide other views
            document.getElementById('libraryView').classList.add('hidden');
            document.getElementById('createView').classList.add('hidden');
            document.getElementById('lessonView').classList.remove('hidden');

            // Render current page
            renderLessonPage();
        }

        // Render the current lesson page
        function renderLessonPage() {
            const contentDiv = document.getElementById('lessonContent');
            const lesson = currentLesson;
            const totalLessons = lesson.lessons.length;
            const totalPages = totalLessons + (lesson.practiceQuestions?.length > 0 ? 1 : 0);

            let html = '';

            // Header
            html += `
                <div class="card-gradient-indigo rounded-2xl p-8 mb-6 animate-slide-in">
                    <h1 class="text-4xl font-black text-white mb-2">${escapeHtml(lesson.subject)}</h1>
                    <p class="text-white/60">Created ${formatDate(lesson.createdAt)}</p>
                    <div class="mt-4 flex items-center gap-2">
                        ${Array.from({length: totalPages}, (_, i) => `
                            <div class="h-2 ${i === currentPage ? 'w-8 bg-white' : 'w-2 bg-white/30'} rounded-full transition-all"></div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Render based on current page
            if (currentPage < totalLessons) {
                // Render individual lesson
                const lessonItem = lesson.lessons[currentPage];
                const gradients = ['purple', 'blue', 'emerald', 'rose'];
                const gradient = gradients[currentPage % gradients.length];

                html += `
                    <div class="bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-8 mb-6 animate-slide-in">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <p class="text-white/60 text-sm mb-1">Lesson ${currentPage + 1} of ${totalLessons}</p>
                                <h2 class="text-3xl font-bold text-white">${escapeHtml(lessonItem.title)}</h2>
                            </div>
                        </div>
                        <div class="space-y-4">
                            ${renderLessonContent(lessonItem.content)}
                        </div>
                    </div>
                `;
            } else {
                // Render practice questions
                if (lesson.practiceQuestions && lesson.practiceQuestions.length > 0) {
                    html += `
                        <div class="card-gradient-fire rounded-2xl p-8 mb-6 animate-slide-in">
                            <h2 class="text-3xl font-bold text-white mb-2">Practice Questions</h2>
                            <p class="text-white/70 mb-6">Test your understanding of all ${totalLessons} lesson${totalLessons !== 1 ? 's' : ''}</p>
                            <div class="space-y-6">
                                ${renderPracticeQuestions(lesson.practiceQuestions)}
                            </div>
                        </div>
                    `;
                }
            }

            // Navigation buttons
            html += `
                <div class="flex items-center justify-between mt-8">
                    <button
                        onclick="navigatePage(-1)"
                        class="btn-secondary flex items-center gap-2 ${currentPage === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${currentPage === 0 ? 'disabled' : ''}
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Previous
                    </button>

                    <div class="text-white/60 text-sm">
                        ${currentPage < totalLessons ? `Lesson ${currentPage + 1} of ${totalLessons}` : 'Practice Questions'}
                    </div>

                    <button
                        onclick="navigatePage(1)"
                        class="btn-primary flex items-center gap-2 ${currentPage >= totalPages - 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${currentPage >= totalPages - 1 ? 'disabled' : ''}
                    >
                        ${currentPage >= totalPages - 1 ? 'Completed' : (currentPage === totalLessons - 1 ? 'Practice Questions' : 'Next')}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            `;

            contentDiv.innerHTML = html;
            window.scrollTo(0, 0);
        }

        // Navigate between pages
        function navigatePage(direction) {
            const totalLessons = currentLesson.lessons.length;
            const totalPages = totalLessons + (currentLesson.practiceQuestions?.length > 0 ? 1 : 0);

            const newPage = currentPage + direction;

            if (newPage >= 0 && newPage < totalPages) {
                currentPage = newPage;
                renderLessonPage();
            }
        }

        // Render lesson content
        function renderLessonContent(content) {
            return content.map(item => {
                switch (item.type) {
                    case 'heading':
                        return `<h3 class="text-2xl font-bold text-white mt-6 mb-3">${escapeHtml(item.text)}</h3>`;
                    case 'paragraph':
                        return `<p class="text-white/80 leading-relaxed">${escapeHtml(item.text)}</p>`;
                    case 'bullet':
                        return `
                            <ul class="space-y-2 ml-6">
                                ${item.items.map(i => `<li class="text-white/80 flex items-start gap-3">
                                    <span class="text-blue-400 mt-1">‚Ä¢</span>
                                    <span>${escapeHtml(i)}</span>
                                </li>`).join('')}
                            </ul>
                        `;
                    case 'highlight':
                        return `
                            <div class="bg-yellow-500/20 border-l-4 border-yellow-400 p-4 rounded-r-xl">
                                <p class="text-yellow-100 font-medium">${escapeHtml(item.text)}</p>
                            </div>
                        `;
                    default:
                        return '';
                }
            }).join('');
        }

        // Render practice questions
        function renderPracticeQuestions(questions) {
            return questions.map((q, index) => `
                <div class="bg-white/5 rounded-xl p-6 question-container" data-question-index="${index}">
                    <p class="text-white font-semibold mb-4">${index + 1}. ${escapeHtml(q.question)}</p>
                    <div class="space-y-2 mb-4">
                        ${q.options.map((option, optIndex) => `
                            <button
                                onclick="checkAnswer(${index}, ${optIndex}, ${q.correctAnswer})"
                                class="w-full text-left px-4 py-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg text-white transition-all option-btn"
                                data-option="${optIndex}"
                            >
                                ${String.fromCharCode(65 + optIndex)}. ${escapeHtml(option)}
                            </button>
                        `).join('')}
                    </div>
                    <div class="explanation hidden bg-blue-500/20 border-l-4 border-blue-400 p-4 rounded-r-lg">
                        <p class="text-blue-100">${escapeHtml(q.explanation)}</p>
                    </div>
                </div>
            `).join('');
        }

        // Check answer
        function checkAnswer(questionIndex, selectedOption, correctAnswer) {
            const container = document.querySelector(`[data-question-index="${questionIndex}"]`);
            const buttons = container.querySelectorAll('.option-btn');
            const explanation = container.querySelector('.explanation');

            // Disable all buttons
            buttons.forEach(btn => btn.disabled = true);

            // Mark correct and incorrect
            buttons.forEach(btn => {
                const optIndex = parseInt(btn.dataset.option);
                if (optIndex === correctAnswer) {
                    btn.classList.add('!bg-green-500/30', 'border-green-400');
                } else if (optIndex === selectedOption) {
                    btn.classList.add('!bg-red-500/30', 'border-red-400');
                }
            });

            // Show explanation
            explanation.classList.remove('hidden');
        }

        // Delete current lesson
        async function deleteCurrentLesson() {
            if (!currentLessonId) return;

            if (confirm('Are you sure you want to delete this lesson? This cannot be undone.')) {
                await window.lessonsStorage.deleteLesson(currentLessonId);
                showLibrary();
            }
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;

            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
